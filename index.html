<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>è‹±ä¼šè©±ãƒ¬ãƒƒã‚¹ãƒ³ï¼ˆãƒ—ãƒ­ãƒˆã‚¿ã‚¤ãƒ—ï¼‰</title>
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 2rem;
    }
    .lesson-line {
      margin: 1rem 0;
      font-size: 1.5rem;
    }
    .english, .japanese {
      display: block;
      margin: 0.5rem 0;
    }
    .controls, .lesson-content {
      margin-top: 2rem;
    }
    .button-row {
      margin: 1rem 0;
    }
    button {
      margin: 0.5rem;
      padding: 0.75rem 1.5rem;
      font-size: 1.2rem;
    }
    #lessonSection {
      display: none;
    }
    #videoSection {
      margin-top: 2rem;
    }
    iframe {
      width: 100%;
      max-width: 560px;
      height: 315px;
      border: none;
    }
  </style>
</head>
<body>
  <h1>ğŸ“ è‹±ä¼šè©±ãƒ¬ãƒƒã‚¹ãƒ³</h1>

  <div id="menuSection">
    <button onclick="startLesson()">â–¶ï¸ ãƒ¬ãƒƒã‚¹ãƒ³é–‹å§‹</button>
  </div>

  <div id="lessonSection">
    <h2>ğŸ¹ ãƒ¬ãƒƒã‚¹ãƒ³ï¼šSVOãƒ¦ãƒ‹ãƒƒãƒˆ</h2>

    <div class="lesson-line">
      <span class="english" id="englishText">I play the piano.</span>
      <span class="japanese" id="japaneseText">ç§ã¯ãƒ”ã‚¢ãƒã‚’å¼¾ãã¾ã™ã€‚</span>
    </div>

    <div class="controls">
      <div class="button-row">
        <button onclick="prevSentence()">â®ï¸ æˆ»ã‚‹</button>
        <button onclick="repeatSentence()">ğŸ” ãƒªãƒ”ãƒ¼ãƒˆ</button>
        <button onclick="nextSentence()">â­ï¸ æ¬¡ã¸</button>
      </div>
      <div class="button-row">
        <button onclick="toggle('english')">ğŸ‡¬ğŸ‡§ è‹±èª è¡¨ç¤º/éè¡¨ç¤º</button>
        <button onclick="toggle('japanese')">ğŸ‡¯ğŸ‡µ æ—¥æœ¬èª è¡¨ç¤º/éè¡¨ç¤º</button>
      </div>
    </div>

    <div id="videoSection">
      <h3>ğŸ¬ å®Ÿéš›ã®ä¼šè©±æ˜ åƒï¼ˆYouglishé¢¨ï¼‰</h3>
      <iframe id="youtubeFrame" src="https://www.youtube.com/embed/6ZLZWHssv7Y?start=5" allowfullscreen></iframe>
    </div>
  </div>

  <audio id="beep" src="https://actions.google.com/sounds/v1/cartoon/wood_plank_flicks.ogg"></audio>

  <script>
    const lessonData = [
      { en: "I play the piano.", ja: "ç§ã¯ãƒ”ã‚¢ãƒã‚’å¼¾ãã¾ã™ã€‚", video: "6ZLZWHssv7Y", start: 5 },
      { en: "You play the guitar.", ja: "ã‚ãªãŸã¯ã‚®ã‚¿ãƒ¼ã‚’å¼¾ãã¾ã™ã€‚", video: "xgO1b0C9y1g", start: 10 },
      { en: "I play soccer.", ja: "ç§ã¯ã‚µãƒƒã‚«ãƒ¼ã‚’ã—ã¾ã™ã€‚", video: "gHkQvNeWzvU", start: 15 }
    ];

    let currentIndex = 0;

    // ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ç¢ºèª
    navigator.mediaDevices.getUserMedia({ audio: true })
      .then(() => console.log("ğŸ¤ ãƒã‚¤ã‚¯ä½¿ç”¨OK"))
      .catch(err => alert("âŒ ãƒã‚¤ã‚¯ã®ä½¿ç”¨ãŒè¨±å¯ã•ã‚Œã¦ã„ã¾ã›ã‚“: " + err));

    function toggle(className) {
      const el = document.querySelector(`#${className}Text`);
      el.style.display = (el.style.display === 'none') ? 'block' : 'none';
    }

    function startLesson() {
      document.getElementById('menuSection').style.display = 'none';
      document.getElementById('lessonSection').style.display = 'block';
      showSentence();
      playLesson();
    }

    function showSentence() {
      const english = document.getElementById('englishText');
      const japanese = document.getElementById('japaneseText');
      const frame = document.getElementById('youtubeFrame');
      english.textContent = lessonData[currentIndex].en;
      japanese.textContent = lessonData[currentIndex].ja;
      const { video, start } = lessonData[currentIndex];
      frame.src = `https://www.youtube.com/embed/${video}?start=${start}&autoplay=0`;
    }

    function nextSentence() {
      if (currentIndex < lessonData.length - 1) {
        currentIndex++;
        showSentence();
        playLesson();
      }
    }

    function prevSentence() {
      if (currentIndex > 0) {
        currentIndex--;
        showSentence();
        playLesson();
      }
    }

    function repeatSentence() {
      showSentence();
      playLesson();
    }

    function playLesson() {
      const sentence = lessonData[currentIndex].en;
      const utterance = new SpeechSynthesisUtterance(sentence);
      utterance.lang = 'en-US';

      const speakWithCheck = () => {
        if (speechSynthesis.getVoices().length === 0) {
          setTimeout(speakWithCheck, 100);
        } else {
          speechSynthesis.speak(utterance);
        }
      };

      speakWithCheck();

      utterance.onend = () => {
        document.getElementById("beep").play();
        listenForSpeech(sentence);
      };
    }

    function listenForSpeech(expectedText) {
      if (!('webkitSpeechRecognition' in window)) return;
      const recognition = new webkitSpeechRecognition();
      recognition.lang = 'en-US';
      recognition.interimResults = false;
      recognition.maxAlternatives = 1;

      recognition.start();

      recognition.onresult = function(event) {
        const userSpeech = event.results[0][0].transcript.trim().toLowerCase();
        const expected = expectedText.trim().toLowerCase();
        if (userSpeech === expected) {
          setTimeout(() => nextSentence(), 1000);
        }
      };

      recognition.onerror = function() {
        console.log("èªè­˜ã‚¨ãƒ©ãƒ¼");
      };
    }
  </script>
</body>
</html>
